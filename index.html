<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noor Transliterate üåü</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }
        .arabic-text {
            font-family: 'Amiri', serif;
            direction: rtl;
        }
        .keyboard-key {
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            touch-action: manipulation;
        }
        .keyboard-key:active {
            transform: translateY(2px);
            opacity: 0.8;
        }
        
        /* Keyboard Themes */
        .kb-theme-white .keyboard-key {
            background-color: #ffffff;
            color: #1e293b;
            border-bottom: 4px solid #e2e8f0;
        }
        .kb-theme-black .keyboard-key {
            background-color: #1e293b;
            color: #f8fafc;
            border-bottom: 4px solid #0f172a;
        }
        .kb-theme-black {
            background-color: #0f172a !important;
        }

        .glass-morphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        .active-tab {
            background-color: #059669;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #10b981;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1em;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .ltr { direction: ltr; text-align: left; }
        .rtl { direction: rtl; text-align: right; }
    </style>
</head>
<body class="p-3 sm:p-4 md:p-6 lg:p-8 text-slate-800">

    <div class="max-w-7xl mx-auto relative">
        
        <!-- Settings Button -->
        <div class="absolute top-0 right-0 z-50">
            <button onclick="toggleSettings()" class="p-2 bg-white rounded-full shadow-sm hover:bg-slate-50 text-slate-500 hover:text-emerald-600 transition-colors" title="API Settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            </button>
        </div>

        <!-- Header -->
        <header class="text-center mb-8">
            <div class="flex justify-center mb-3">
                <div class="p-3 bg-white rounded-2xl shadow-sm border border-slate-100">
                    <svg width="50" height="50" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-emerald-600">
                        <path d="M50 10L15 25V75L50 90L85 75V25L50 10Z" stroke="currentColor" stroke-width="4" stroke-linejoin="round" fill="white"/>
                        <path d="M50 20V80M25 35C25 35 35 40 50 40C65 40 75 35 75 35M25 50C25 50 35 55 50 55C65 55 75 50 75 50M25 65C25 65 35 70 50 70C65 70 75 65 75 65" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                    </svg>
                </div>
            </div>
            <h1 class="text-3xl sm:text-4xl font-extrabold text-slate-800 tracking-tight">Noor Transliterate üåü</h1>
            <p class="text-slate-500 mt-2 font-medium italic">Multi-Engine Arabic Phonetics & Technical Standards</p>
        </header>

        <!-- Mode Toggle -->
        <div class="flex justify-center mb-8">
            <div class="inline-flex rounded-2xl shadow-sm bg-white p-1.5 border border-slate-200">
                <button id="modeStandard" onclick="setMode('standard')" class="px-5 sm:px-8 py-2.5 rounded-xl text-xs sm:text-sm font-bold transition-all active-tab">Standard</button>
                <button id="modeArabizi" onclick="setMode('arabizi')" class="px-5 sm:px-8 py-2.5 rounded-xl text-xs sm:text-sm font-bold transition-all text-slate-500 hover:bg-slate-50">Arabizi (3rb)</button>
                <button id="modeQuran" onclick="setMode('quran')" class="px-5 sm:px-8 py-2.5 rounded-xl text-xs sm:text-sm font-bold transition-all text-slate-500 hover:bg-slate-50 flex items-center gap-1">üìñ Quran Search</button>
            </div>
        </div>

        <!-- AI Assistant Bar -->
        <div class="flex flex-wrap justify-center gap-4 mb-10">
            <button onclick="aiRefineText()" class="px-5 py-3 bg-emerald-600 text-white rounded-full shadow-lg text-sm font-bold hover:bg-emerald-700 transition-all flex items-center gap-2"><span>‚ú® AI Harakat Fix</span></button>
            <button id="translitFixBtn" onclick="aiCycleTranslitFix()" class="px-5 py-3 bg-blue-600 text-white rounded-full shadow-lg text-sm font-bold hover:bg-blue-700 transition-all flex items-center gap-2"><span>‚ú® Fix Translit (Academic)</span></button>
            <button onclick="aiReflectText()" class="px-5 py-3 bg-white border border-blue-200 text-blue-700 rounded-full shadow-sm text-sm font-bold hover:bg-blue-50 transition-all flex items-center gap-2"><span>‚ú® AI Reflection</span></button>
            <button onclick="aiSpeakText()" class="px-5 py-3 bg-white border border-purple-200 text-purple-700 rounded-full shadow-sm text-sm font-bold hover:bg-purple-50 transition-all flex items-center gap-2"><span>‚ú® Divine Voice</span></button>
        </div>

        <!-- Loading Indicator -->
        <div id="aiLoading" class="hidden flex justify-center mb-8">
            <div class="flex items-center gap-3 bg-white px-8 py-4 rounded-2xl shadow-xl border border-slate-100">
                <div class="loading-spinner"></div>
                <span class="text-sm font-semibold text-slate-600 italic" id="aiLoadingText">Connecting to Gemini...</span>
            </div>
        </div>

        <div class="space-y-8">
            <!-- Quran Pick UI -->
            <div id="quranPickContainer" class="hidden glass-morphism rounded-3xl p-6 md:p-8 shadow-xl border-t-8 border-emerald-600 space-y-6">
                <div class="flex items-center gap-3 mb-2 text-emerald-900">
                    <span class="text-2xl">üìñ</span>
                    <span class="text-lg font-extrabold uppercase tracking-widest">Quran Verse Picker</span>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="flex flex-col gap-1.5">
                        <label class="text-[11px] font-black text-slate-400 uppercase tracking-wider ml-1">By Juz</label>
                        <select id="pickJuz" onchange="handleJuzChange()" class="p-3 rounded-xl border border-slate-200 text-sm bg-white outline-none focus:ring-2 focus:ring-emerald-500 transition-all"></select>
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <label class="text-[11px] font-black text-slate-400 uppercase tracking-wider ml-1">By Surah</label>
                        <select id="pickSurah" onchange="handleSurahChange()" class="p-3 rounded-xl border border-slate-200 text-sm bg-white outline-none focus:ring-2 focus:ring-emerald-500 transition-all"></select>
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <label class="text-[11px] font-black text-slate-400 uppercase tracking-wider ml-1">By Ayah</label>
                        <select id="pickAyah" onchange="handleAyahChange()" class="p-3 rounded-xl border border-slate-200 text-sm bg-white outline-none focus:ring-2 focus:ring-emerald-500 transition-all"></select>
                    </div>
                </div>
                <div class="flex gap-3">
                    <input type="text" id="quranKeyword" placeholder="Search ref (e.g. '2:255') or keyword..." class="flex-1 p-4 rounded-2xl border border-slate-200 text-sm outline-none focus:ring-2 focus:ring-emerald-500 shadow-inner" onkeypress="if(event.key==='Enter') handleUnifiedSearch()">
                    <button onclick="handleUnifiedSearch()" class="px-8 py-4 bg-slate-800 text-white rounded-2xl text-sm font-black hover:bg-slate-900 transition-all shadow-md">Search</button>
                </div>
                <div id="quranResults" class="hidden max-h-60 overflow-y-auto space-y-3 mt-4 pr-1 custom-scrollbar"></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8">
                <!-- Input Card -->
                <div class="glass-morphism rounded-3xl p-6 md:p-8 shadow-xl border-b-8 border-emerald-500 flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <label id="inputLabel" class="text-xs sm:text-sm font-black text-slate-700 uppercase tracking-widest">Input Master Script</label>
                        <div class="flex gap-3">
                            <button onclick="pasteText()" class="text-[11px] font-black text-emerald-600 hover:text-emerald-700 uppercase flex items-center gap-1.5">üìã Paste</button>
                            <span class="text-slate-300">|</span>
                            <button onclick="clearText('input')" class="text-[11px] font-black text-red-500 hover:text-red-700 uppercase">Clear</button>
                        </div>
                    </div>
                    <textarea 
                        id="mainInput" 
                        class="w-full h-40 sm:h-56 p-5 rounded-2xl border border-slate-200 focus:ring-4 focus:ring-emerald-500/20 outline-none transition-all text-2xl sm:text-3xl shadow-inner bg-white/50"
                        placeholder="Type here..."
                    ></textarea>
                </div>

                <!-- Output Card -->
                <div class="glass-morphism rounded-3xl p-6 md:p-8 shadow-xl border-b-8 border-blue-500 flex flex-col space-y-6 relative">
                    
                    <div id="arabicResultSection" class="hidden animate-in fade-in slide-in-from-top-2">
                         <div class="flex justify-between items-center mb-2">
                            <label class="text-[11px] font-black text-slate-500 uppercase tracking-widest">Arabic Script Result (Editable)</label>
                            <button onclick="updateTranslitFromArabicEdit()" class="px-3 py-1 bg-emerald-50 text-emerald-700 text-[10px] font-black rounded-lg border border-emerald-200 hover:bg-emerald-100 uppercase transition-all">Update Translit ‚ö°</button>
                        </div>
                        <textarea id="outputArabicEditable" class="w-full p-4 rounded-2xl bg-white border border-slate-200 text-2xl sm:text-3xl arabic-text shadow-inner min-h-[120px] rtl" dir="rtl"></textarea>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-[11px] font-black text-slate-500 uppercase tracking-widest">Formal Transliteration (Editable)</label>
                            <button onclick="copyText('output1')" class="text-[11px] font-black text-blue-600 hover:underline uppercase">Copy üìã</button>
                        </div>
                        <textarea id="output1" class="w-full p-4 rounded-2xl bg-white/60 border border-slate-200 text-lg italic leading-relaxed shadow-inner min-h-[100px] ltr" dir="ltr" placeholder="Phonetic output appears here..."></textarea>
                    </div>

                    <div id="translationContainer" class="hidden">
                        <label class="text-[11px] font-black text-slate-500 uppercase tracking-widest block mb-2">English Meaning</label>
                        <div id="outputTranslation" class="w-full p-5 rounded-2xl bg-purple-50/80 border border-purple-100 text-base sm:text-lg leading-relaxed text-slate-800 ltr italic" dir="ltr"></div>
                    </div>

                    <div id="aiInsightsContainer" class="hidden mt-2 p-6 rounded-2xl bg-blue-50 border border-blue-100 shadow-sm animate-in zoom-in-95 duration-300">
                        <div class="flex justify-between items-start mb-3">
                            <span class="text-[11px] font-black text-blue-800 uppercase tracking-widest italic flex items-center gap-2">‚ú® Noor Wisdom Reflection</span>
                            <button onclick="document.getElementById('aiInsightsContainer').classList.add('hidden')" class="text-blue-400 hover:text-blue-600 text-lg">‚úï</button>
                        </div>
                        <div id="aiInsightsContent" class="text-sm sm:text-base text-blue-900 leading-relaxed italic ltr" dir="ltr"></div>
                    </div>

                    <div id="copyBadge" class="hidden text-center text-emerald-600 text-xs font-black animate-bounce">Copied successfully! ‚úÖ</div>
                </div>
            </div>

            <!-- Keyboard Section -->
            <div id="keyboardSection" class="glass-morphism rounded-3xl p-6 md:p-8 shadow-xl border-b-8 border-slate-400 overflow-hidden transition-all duration-300">
                <div class="flex items-center justify-between mb-5 border-b border-slate-100 pb-3">
                    <div class="flex items-center gap-3 text-slate-700">
                        <span class="text-2xl">‚å®Ô∏è</span>
                        <span class="text-sm font-black uppercase tracking-widest">Arabic Virtual Keyboard</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="setKeyboardTheme('white')" class="w-8 h-8 rounded-full bg-white border border-slate-300 shadow-sm" title="White Theme"></button>
                        <button onclick="setKeyboardTheme('black')" class="w-8 h-8 rounded-full bg-slate-800 shadow-sm" title="Black Theme"></button>
                    </div>
                </div>
                <div id="keyboardGrid" class="grid grid-cols-6 sm:grid-cols-10 md:grid-cols-12 lg:grid-cols-14 gap-2 p-1"></div>
            </div>
        </div>
        
        <footer class="mt-12 sm:mt-16 text-center text-slate-400 text-xs space-y-3 font-medium">
            <p>‚ÄúAnd We have certainly made the Quran easy for remembrance...‚Äù (54:17)</p>
            <p>¬© Noor Transliterate ‚Ä¢ Professional AI Tools</p>
        </footer>
    </div>

    <!-- API Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl border-t-8 border-emerald-600">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-black text-slate-800 tracking-tight">AI Settings</h3>
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-slate-600 text-xl font-bold">‚úï</button>
            </div>
            <p class="text-sm text-slate-500 mb-6">Provide your <strong>Gemini API key</strong>. Leave empty for defaults.</p>
            <div class="space-y-5">
                <input type="password" id="apiKeyInput" placeholder="AIzaSy..." class="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none shadow-inner">
                <button onclick="saveApiKey()" class="w-full py-4 bg-emerald-600 text-white rounded-2xl font-black hover:bg-emerald-700 shadow-lg">Save Key</button>
            </div>
        </div>
    </div>

    <script>
        const apiKey = "";
        let currentMode = 'standard';
        let surahData = [];
        let translitFixIndex = 0;

        const mainInput = document.getElementById('mainInput');
        const output1 = document.getElementById('output1');
        const outputArabicEditable = document.getElementById('outputArabicEditable');
        const arabicResultSection = document.getElementById('arabicResultSection');
        const translationContainer = document.getElementById('translationContainer');
        const outputTranslation = document.getElementById('outputTranslation');
        const inputLabel = document.getElementById('inputLabel');
        const aiLoading = document.getElementById('aiLoading');
        const aiInsightsContainer = document.getElementById('aiInsightsContainer');
        const aiInsightsContent = document.getElementById('aiInsightsContent');
        const settingsModal = document.getElementById('settingsModal');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const quranResults = document.getElementById('quranResults');
        const keyboardGrid = document.getElementById('keyboardGrid');
        const keyboardSection = document.getElementById('keyboardSection');

        // Layout Keys
        const keys = [
            '\u064E', '\u064F', '\u0650', '\u0651', '\u0652', '\u064B', '\u064C', '\u064D', '\u0670',
            'ÿ∂', 'ÿµ', 'ÿ´', 'ŸÇ', 'ŸÅ', 'ÿ∫', 'ÿπ', 'Ÿá', 'ÿÆ', 'ÿ≠', 'ÿ¨', 'ÿØ',
            'ÿ¥', 'ÿ≥', 'Ÿä', 'ÿ®', 'ŸÑ', 'ÿß', 'ÿ™', 'ŸÜ', 'ŸÖ', 'ŸÉ', 'ÿ∑',
            'ÿ¶', 'ÿ°', 'ÿ§', 'ÿ±', 'ŸÑÿß', 'Ÿâ', 'ÿ©', 'Ÿà', 'ÿ≤', 'ÿ∏', 'ÿ∞',
            'Ÿ°', 'Ÿ¢', 'Ÿ£', 'Ÿ§', 'Ÿ•', 'Ÿ¶', 'Ÿß', 'Ÿ®', 'Ÿ©', 'Ÿ†',
            'Space', 'Bksp'
        ];

        // Mappings
        const arToEn = { 
            'ÿß': 'a', 'ÿ£': 'a', 'ÿ•': 'i', 'ÿ¢': 'ƒÅ', 'ÿ®': 'b', 'ÿ™': 't', 'ÿ´': 'th', 'ÿ¨': 'j', 'ÿ≠': '·∏•', 'ÿÆ': 'kh', 'ÿØ': 'd', 'ÿ∞': 'dh', 'ÿ±': 'r', 'ÿ≤': 'z', 'ÿ≥': 's', 'ÿ¥': 'sh', 'ÿµ': '·π£', 'ÿ∂': '·∏ç', 'ÿ∑': '·π≠', 'ÿ∏': '·∫ì', 'ÿπ': '‚Äò', 'ÿ∫': 'gh', 'ŸÅ': 'f', 'ŸÇ': 'q', 'ŸÉ': 'k', 'ŸÑ': 'l', 'ŸÖ': 'm', 'ŸÜ': 'n', 'Ÿá': 'h', 'Ÿà': 'w', 'Ÿä': 'y', 'ÿ©': 'h', 'Ÿâ': 'ƒÅ', 'ÿ°': "'", 'ÿ¶': "'", 'ÿ§': "'", 
            '\u064E': 'a', '\u064F': 'u', '\u0650': 'i', '\u0651': '', '\u0652': '', '\u064B': 'an', '\u064C': 'un', '\u064D': 'in', '\u0670': 'ƒÅ' 
        };
        const chatToAr = { "3'": "ÿ∫", "3*": "ÿ∫", "gh": "ÿ∫", "6'": "ÿ∏", "6*": "ÿ∏", "zh": "ÿ∏", "9'": "ÿ∂", "9*": "ÿ∂", "dh": "ÿ∂", "7'": "ÿÆ", "7*": "ÿÆ", "kh": "ÿÆ", "5": "ÿÆ", "sh": "ÿ¥", "ch": "ÿ¥", "4": "ÿ¥", "th": "ÿ´", "ee": "Ÿä", "oo": "Ÿà", "ou": "Ÿà", "uu": "Ÿà", "aa": "ÿß", "2": "ÿ£", "3": "ÿπ", "6": "ÿ∑", "7": "ÿ≠", "8": "ŸÇ", "9": "ÿµ", "a": "ÿß", "b": "ÿ®", "t": "ÿ™", "j": "ÿ¨", "d": "ÿØ", "r": "ÿ±", "z": "ÿ≤", "s": "ÿ≥", "f": "ŸÅ", "k": "ŸÉ", "l": "ŸÑ", "m": "ŸÖ", "n": "n", "h": "Ÿá", "w": "Ÿà", "y": "Ÿä", "i": "Ÿä", "u": "Ÿà", "e": "ÿß", "o": "Ÿà" };

        function toggleSettings() { settingsModal.classList.toggle('hidden'); }
        function saveApiKey() { localStorage.setItem('gemini_api_key', apiKeyInput.value.trim()); toggleSettings(); alert("API Key saved successfully!"); }
        function setKeyboardTheme(theme) {
            keyboardSection.classList.remove('kb-theme-white', 'kb-theme-black');
            keyboardSection.classList.add('kb-theme-' + theme);
            localStorage.setItem('kb_theme', theme);
        }

        async function callGemini(payload, model = 'gemini-2.5-flash-preview-09-2025') {
            const userKey = localStorage.getItem('gemini_api_key') || apiKey;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${userKey}`;
            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) { const err = await response.json(); throw new Error(err.error?.message || "Gemini Error"); }
                    return await response.json();
                } catch (e) {
                    if (i === 4) throw e;
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            }
        }

        // --- Multi-Source Transliteration Fix Engine ---
        async function aiCycleTranslitFix() {
            const input = outputArabicEditable.value.trim() || mainInput.value.trim();
            if(!input) return;

            const engines = [
                { id: "academic", name: "Academic (ALA-LC)", prompt: "Provide a strict academic transliteration using ALA-LC standards (dots under ·π£, ·∏ç, ·π≠, ·∫ì, etc)." },
                { id: "satts", name: "Technical (SATTS)", prompt: "Use the Standard Arabic Technical Transliteration System (SATTS) commonly used in military and technical contexts." },
                { id: "library", name: "Library Systems (ISO/DIN)", prompt: "Follow specialized academic library cataloging standards (like DIN 31635 or ISO 233) for manuscript precision." },
                { id: "modern", name: "Modern Phonetic", prompt: "Provide a phonetic transliteration designed for easy pronunciation by English speakers." },
                { id: "tajweed", name: "Traditional Tajweed", prompt: "Highlight Tajweed pronunciation rules like Ghunnah and Madd signs clearly." }
            ];

            const currentEngine = engines[translitFixIndex % engines.length];
            aiLoading.classList.remove('hidden');
            document.getElementById('aiLoadingText').innerText = `Fixing using: ${currentEngine.name}...`;

            try {
                const prompt = `Rewrite ONLY the transliteration for the text: "${input}". Logic: ${currentEngine.prompt}. Output string only.`;
                const result = await callGemini({ contents: [{ parts: [{ text: prompt }] }] });
                output1.value = result.candidates[0].content.parts[0].text.trim();
                
                translitFixIndex++;
                const nextEngine = engines[translitFixIndex % engines.length];
                document.getElementById('translitFixBtn').innerHTML = `<span>‚ú® Fix Translit (${nextEngine.name})</span>`;
            } catch (e) {
                alert("AI Fix Error: " + e.message);
            } finally {
                aiLoading.classList.add('hidden');
            }
        }

        async function aiRefineText() {
            const input = mainInput.value.trim();
            if(!input) return;
            aiLoading.classList.remove('hidden');
            try {
                const prompt = `Rewrite this Arabic text with FULL Harakat. Preserve spaces. Output JSON: {"arabic": "...", "transliteration": "..."}. Input: "${input}"`;
                const result = await callGemini({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } });
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                outputArabicEditable.value = data.arabic;
                output1.value = data.transliteration;
                arabicResultSection.classList.remove('hidden');
            } catch (e) { alert("AI Error"); } finally { aiLoading.classList.add('hidden'); }
        }

        async function aiReflectText() {
            const input = outputArabicEditable.value.trim() || mainInput.value.trim();
            if(!input) return;
            aiLoading.classList.remove('hidden');
            try {
                const result = await callGemini({ contents: [{ parts: [{ text: `Deep linguistic/spiritual reflection on: "${input}"` }] }] });
                aiInsightsContent.innerText = result.candidates[0].content.parts[0].text;
                aiInsightsContainer.classList.remove('hidden');
            } catch (e) { alert("AI Error"); } finally { aiLoading.classList.add('hidden'); }
        }

        async function aiSpeakText() {
            const input = outputArabicEditable.value.trim() || mainInput.value.trim();
            if(!input) return;
            aiLoading.classList.remove('hidden');
            try {
                const res = await callGemini({ contents: [{ parts: [{ text: `Say clearly: ${input}` }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } } }, "gemini-2.5-flash-preview-tts");
                const audioData = res.candidates[0].content.parts[0].inlineData.data;
                const binary = atob(audioData);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                const wavHeader = new ArrayBuffer(44);
                const view = new DataView(wavHeader);
                const writeString = (o, s) => { for (let i = 0; i < s.length; i++) view.setUint8(o + i, s.charCodeAt(i)); };
                writeString(0, 'RIFF'); view.setUint32(4, 36 + bytes.length, true); writeString(8, 'WAVE'); writeString(12, 'fmt ');
                view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true);
                view.setUint32(24, 24000, true); view.setUint32(28, 48000, true);
                view.setUint16(32, 2, true); view.setUint16(34, 16, true); writeString(36, 'data'); view.setUint32(40, bytes.length, true);
                const blob = new Blob([wavHeader, bytes], { type: 'audio/wav' });
                new Audio(URL.createObjectURL(blob)).play();
            } catch (e) { alert("Voice Error."); } finally { aiLoading.classList.add('hidden'); }
        }

        function performFormalTransliteration(text) {
            let res = "";
            for (let i = 0; i < text.length; i++) {
                const char = text[i], next = text[i+1];
                if (next === '\u0651') { res += (arToEn[char] || "") + (arToEn[char] || ""); i++; continue; }
                if (char === 'ÿß' && next === 'ŸÑ' && (i === 0 || text[i-1] === ' ')) { res += "al-"; i++; continue; }
                const translated = arToEn[char];
                res += (translated !== undefined) ? translated : char;
            }
            return res.charAt(0).toUpperCase() + res.slice(1);
        }

        function process() {
            const text = mainInput.value;
            if (!text.trim()) { output1.value = "Waiting..."; outputArabicEditable.value = ""; return; }
            if (currentMode === 'standard' || currentMode === 'quran') {
                if(translationContainer.classList.contains('hidden')) output1.value = performFormalTransliteration(text);
            } else {
                let arabicBuild = "";
                text.split(/(\s+)/).forEach((part) => {
                    if (!part) return;
                    if (/\s+/.test(part)) { arabicBuild += part; return; }
                    arabicBuild += convertWordToArabic(part.toLowerCase());
                });
                arabicResultSection.classList.remove('hidden');
                outputArabicEditable.value = arabicBuild;
                output1.value = performFormalTransliteration(arabicBuild);
            }
        }

        function updateTranslitFromArabicEdit() { output1.value = performFormalTransliteration(outputArabicEditable.value); }

        function convertWordToArabic(word) {
            let w = "", j = 0;
            const sortedKeys = Object.keys(chatToAr).sort((a, b) => b.length - a.length);
            if (word.startsWith('al-')) { w += "ÿßŸÑ"; j = 3; }
            while(j < word.length) {
                let matched = false;
                for (const key of sortedKeys) { if (word.substr(j, key.length) === key) { w += chatToAr[key]; j += key.length; matched = true; break; } }
                if (!matched) { w += word[j]; j++; }
            }
            return w;
        }

        async function handleUnifiedSearch() {
            const query = document.getElementById('quranKeyword').value.trim();
            if (!query) return;
            aiLoading.classList.remove('hidden');
            try {
                const refMatch = query.match(/^(\d+):(\d+)$/);
                if (refMatch) {
                    const response = await fetch(`https://api.alquran.cloud/v1/ayah/${query}/editions/quran-uthmani,en.transliteration,en.sahih`);
                    const data = await response.json();
                    if(data.code === 200) {
                        mainInput.value = data.data[0].text;
                        outputArabicEditable.value = data.data[0].text;
                        output1.value = data.data[1].text;
                        outputTranslation.innerText = data.data[2].text;
                        arabicResultSection.classList.remove('hidden');
                        translationContainer.classList.remove('hidden');
                        quranResults.classList.add('hidden');
                    }
                } else {
                    const response = await fetch(`https://api.alquran.cloud/v1/search/${query}/all/en.sahih`);
                    const data = await response.json();
                    quranResults.innerHTML = "";
                    if(data.code === 200 && data.data.matches.length > 0) {
                        quranResults.classList.remove('hidden');
                        data.data.matches.slice(0, 10).forEach(m => {
                            const div = document.createElement('div');
                            div.className = "p-4 rounded-2xl border border-emerald-100 cursor-pointer text-xs mb-2 transition-all bg-white hover:border-emerald-500 shadow-sm";
                            div.innerHTML = `<div class="font-black text-emerald-700 uppercase">${m.surah.englishName} (${m.surah.number}:${m.numberInSurah})</div><p class="text-slate-600 line-clamp-2">${m.text}</p>`;
                            div.onclick = () => { document.getElementById('quranKeyword').value = `${m.surah.number}:${m.numberInSurah}`; handleUnifiedSearch(); };
                            quranResults.appendChild(div);
                        });
                    }
                }
            } catch (e) {} finally { aiLoading.classList.add('hidden'); }
        }

        async function fetchQuranMetadata() {
            try {
                const response = await fetch('https://api.alquran.cloud/v1/surah');
                const data = await response.json();
                surahData = data.data;
                const sSelect = document.getElementById('pickSurah');
                sSelect.innerHTML = '<option value="">Select Surah</option>';
                surahData.forEach(s => { sSelect.innerHTML += `<option value="${s.number}">${s.number}. ${s.englishName}</option>`; });
                const jSelect = document.getElementById('pickJuz');
                jSelect.innerHTML = '<option value="">Select Juz</option>';
                for(let i=1; i<=30; i++) { jSelect.innerHTML += `<option value="${i}">Juz ${i}</option>`; }
            } catch (e) {}
        }

        function handleJuzChange() { const juz = document.getElementById('pickJuz').value; if(juz) fetchVerseByRef(`juz/${juz}/quran-uthmani`); }
        function handleSurahChange() {
            const surahNum = document.getElementById('pickSurah').value;
            const aSelect = document.getElementById('pickAyah');
            aSelect.innerHTML = '<option value="">Ayah</option>';
            if(!surahNum) return;
            const s = surahData.find(x => x.number == surahNum);
            for(let i=1; i<=s.numberOfAyahs; i++) { aSelect.innerHTML += `<option value="${i}">${i}</option>`; }
        }
        function handleAyahChange() {
            const surah = document.getElementById('pickSurah').value;
            const ayah = document.getElementById('pickAyah').value;
            if(surah && ayah) fetchVerseByRef(`${surah}:${ayah}`);
        }
        async function fetchVerseByRef(ref) { document.getElementById('quranKeyword').value = ref; handleUnifiedSearch(); }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('[id^="mode"]').forEach(b => b.classList.remove('active-tab'));
            document.getElementById('mode' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active-tab');
            document.getElementById('quranPickContainer').classList.toggle('hidden', mode !== 'quran');
            mainInput.style.textAlign = (mode === 'arabizi') ? 'left' : 'right';
            mainInput.setAttribute('dir', (mode === 'arabizi') ? 'ltr' : 'rtl');
            process();
        }

        function initKeyboard() {
            keyboardGrid.innerHTML = "";
            keys.forEach(key => {
                const btn = document.createElement('button');
                let fontSize = "text-xl sm:text-3xl"; 
                if (key === 'Space' || key === 'Bksp') fontSize = "text-[10px] uppercase tracking-tighter";
                if (key === 'ŸÑÿß') fontSize = "text-lg";
                btn.className = `keyboard-key p-2 sm:p-3 rounded-xl font-bold shadow-sm ${fontSize}`;
                btn.innerText = key;
                btn.onclick = () => {
                    const s = mainInput.selectionStart, v = mainInput.value;
                    if (key === 'Bksp') { mainInput.value = v.substring(0, Math.max(0, s - 1)) + v.substring(s); mainInput.selectionStart = mainInput.selectionEnd = Math.max(0, s - 1); }
                    else if (key === 'Space') { mainInput.value = v.substring(0, s) + ' ' + v.substring(s); mainInput.selectionStart = mainInput.selectionEnd = s + 1; }
                    else { mainInput.value = v.substring(0, s) + key + v.substring(s); mainInput.selectionStart = mainInput.selectionEnd = s + key.length; }
                    mainInput.focus(); process();
                };
                keyboardGrid.appendChild(btn);
            });
            setKeyboardTheme(localStorage.getItem('kb_theme') || 'white');
        }

        function pasteText() { navigator.clipboard.readText().then(t => { mainInput.value += t; process(); }).catch(() => alert("Paste manually with Ctrl+V")); }
        function clearText(t) {
            if(t === 'input') { mainInput.value = ""; outputArabicEditable.value = ""; process(); translationContainer.classList.add('hidden'); aiInsightsContainer.classList.add('hidden'); }
            else { output1.value = "Waiting..."; outputTranslation.innerText = ""; translationContainer.classList.add('hidden'); }
        }
        function copyText(id) {
            const el = document.getElementById(id);
            const val = el.tagName === 'TEXTAREA' ? el.value : el.innerText;
            const temp = document.createElement('textarea'); temp.value = val; document.body.appendChild(temp); temp.select(); document.execCommand('copy'); document.body.removeChild(temp);
            document.getElementById('copyBadge').classList.remove('hidden'); setTimeout(() => document.getElementById('copyBadge').classList.add('hidden'), 2000);
        }

        window.addEventListener('load', () => { 
            if(localStorage.getItem('gemini_api_key')) apiKeyInput.value = localStorage.getItem('gemini_api_key'); 
            initKeyboard(); fetchQuranMetadata(); setMode('standard'); 
        });
        mainInput.addEventListener('input', process);
    </script>
</body>
</html>

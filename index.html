<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noor Transliterate üåü</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            min-height: 100vh;
        }
        .arabic-text {
            font-family: 'Amiri', serif;
            direction: rtl;
        }
        .keyboard-key {
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            touch-action: manipulation;
        }
        .keyboard-key:active {
            transform: translateY(2px);
            background-color: #ecfdf5;
        }
        .glass-morphism {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        .active-tab {
            background-color: #10b981;
            color: white;
        }
        .selectable-word {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 6px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .selectable-word:hover {
            background: rgba(16, 185, 129, 0.15);
            border-color: #10b981;
        }
        .suggestion-popup {
            position: absolute;
            z-index: 100;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            display: none;
            min-width: 150px;
        }
        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #10b981;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="p-3 sm:p-4 md:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto relative">
        
        <!-- Settings Button (Top Right) -->
        <div class="absolute top-0 right-0 z-50">
            <button onclick="toggleSettings()" class="p-2 bg-white/80 rounded-full shadow-sm hover:bg-white text-slate-500 hover:text-emerald-600 transition-colors" title="API Settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            </button>
        </div>

        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-slate-800 flex justify-center items-center gap-2">
                Noor Transliterate üåü
            </h1>
            <p class="text-slate-500 mt-1 italic text-xs sm:text-sm md:text-base">Advanced Phonetic & AI Intelligence</p>
        </header>

        <!-- Mode Toggle -->
        <div class="flex justify-center mb-6">
            <div class="inline-flex rounded-xl shadow-sm bg-white p-1 glass-morphism border border-slate-200">
                <button id="modeStandard" onclick="setMode('standard')" class="px-4 sm:px-8 py-2 rounded-lg text-sm font-semibold transition-all active-tab">
                    Standard (ÿπ ‚Üí abc)
                </button>
                <button id="modeArabizi" onclick="setMode('arabizi')" class="px-4 sm:px-8 py-2 rounded-lg text-sm font-semibold transition-all text-slate-500 hover:bg-slate-50">
                    Arabizi (3rb ‚Üí ÿπ)
                </button>
            </div>
        </div>

        <!-- AI Assistant Bar -->
        <div class="flex flex-wrap justify-center gap-3 mb-8">
            <button onclick="aiRefineText()" class="px-4 py-2 bg-white border border-emerald-200 rounded-full shadow-sm text-sm font-semibold text-emerald-700 hover:bg-emerald-50 transition-all flex items-center gap-2">
                <span>‚ú® Smart AI Fix</span>
            </button>
            <button onclick="aiReflectText()" class="px-4 py-2 bg-white border border-blue-200 rounded-full shadow-sm text-sm font-semibold text-blue-700 hover:bg-blue-50 transition-all flex items-center gap-2">
                <span>‚ú® AI Deep Reflection</span>
            </button>
            <button onclick="aiSpeakText()" class="px-4 py-2 bg-white border border-purple-200 rounded-full shadow-sm text-sm font-semibold text-purple-700 hover:bg-purple-50 transition-all flex items-center gap-2">
                <span>‚ú® Divine Voice</span>
            </button>
        </div>

        <!-- Loading Indicator -->
        <div id="aiLoading" class="hidden flex justify-center mb-6">
            <div class="flex items-center gap-3 bg-white px-6 py-3 rounded-full shadow-md border border-slate-100">
                <div class="loading-spinner"></div>
                <span class="text-sm font-medium text-slate-600 italic" id="aiLoadingText">Consulting Noor AI...</span>
            </div>
        </div>

        <div class="space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                <!-- Input Card -->
                <div class="glass-morphism rounded-2xl p-4 md:p-6 shadow-lg border-b-4 border-emerald-500">
                    <div class="flex justify-between items-center mb-3">
                        <label id="inputLabel" class="text-xs sm:text-sm font-semibold text-slate-700 uppercase tracking-wide">Input</label>
                        <button onclick="clearText()" class="text-[10px] sm:text-xs font-bold text-red-500 hover:text-red-700 uppercase tracking-wider">
                            Clear
                        </button>
                    </div>
                    <textarea 
                        id="mainInput" 
                        class="w-full h-32 sm:h-40 md:h-48 p-3 sm:p-4 rounded-xl border border-slate-200 focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all text-xl sm:text-2xl md:text-3xl shadow-inner bg-white/50"
                        placeholder="Type here..."
                    ></textarea>
                </div>

                <!-- Output Card -->
                <div class="glass-morphism rounded-2xl p-4 md:p-6 shadow-lg border-b-4 border-blue-500 flex flex-col space-y-4 relative">
                    <!-- Transliteration Output -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-[10px] sm:text-xs font-semibold text-slate-500 uppercase tracking-wider">Formal Transliteration</label>
                            <div class="flex gap-3">
                                <button onclick="copyText('output1')" class="text-[10px] font-bold text-blue-600 hover:underline uppercase">Copy üìã</button>
                            </div>
                        </div>
                        <div id="output1" class="w-full p-3 sm:p-4 rounded-xl bg-white/40 border border-slate-100 text-base sm:text-lg italic whitespace-pre-wrap leading-relaxed shadow-inner min-h-[80px]">
                            Waiting...
                        </div>
                    </div>

                    <!-- Arabic Script Output (For Arabizi Mode) -->
                    <div id="output2Container" class="hidden">
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-[10px] sm:text-xs font-semibold text-slate-500 uppercase tracking-wider">Arabic Script (Click word to fix)</label>
                            <button onclick="copyText('output2')" class="text-[10px] font-bold text-emerald-600 hover:underline uppercase">Copy üìã</button>
                        </div>
                        <div id="output2" class="w-full p-3 sm:p-4 rounded-xl bg-white/40 border border-slate-100 text-2xl sm:text-4xl arabic-text shadow-inner min-h-[100px] flex flex-wrap gap-x-2 gap-y-1 content-start">
                            -
                        </div>
                    </div>

                    <!-- AI Insights Box -->
                    <div id="aiInsightsContainer" class="hidden mt-2 p-4 rounded-xl bg-blue-50 border border-blue-100 shadow-sm animate-in fade-in slide-in-from-top-2">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] font-bold text-blue-800 uppercase tracking-wider">‚ú® Noor Reflection</span>
                            <button onclick="document.getElementById('aiInsightsContainer').classList.add('hidden')" class="text-blue-400 hover:text-blue-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                        <div id="aiInsightsContent" class="text-xs sm:text-sm text-blue-900 leading-relaxed italic"></div>
                    </div>

                    <!-- Suggestion Menu (Popup) -->
                    <div id="suggestionMenu" class="suggestion-popup overflow-hidden">
                        <div class="bg-slate-50 px-3 py-2 text-[10px] font-bold text-slate-400 border-b flex justify-between">
                            <span>SMART FIXES</span>
                            <span class="text-emerald-500">Manual Suggestions</span>
                        </div>
                        <div id="suggestionList" class="flex flex-col max-h-60 overflow-y-auto"></div>
                    </div>

                    <div id="copyBadge" class="hidden text-center text-emerald-600 text-[10px] font-bold animate-pulse">
                        Copied to clipboard! ‚úÖ
                    </div>
                </div>
            </div>

            <!-- Keyboard Section -->
            <div id="keyboardSection" class="glass-morphism rounded-2xl p-3 sm:p-4 md:p-6 shadow-lg">
                <div class="flex items-center gap-2 mb-3 sm:mb-4 text-slate-700 border-b border-slate-100 pb-2">
                    <span class="text-base sm:text-lg">‚å®Ô∏è</span>
                    <span class="text-[10px] sm:text-sm font-semibold uppercase tracking-wide">Arabic Virtual Keyboard</span>
                </div>
                <div id="keyboardGrid" class="grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 lg:grid-cols-12 gap-1 sm:gap-2"></div>
            </div>
        </div>
        
        <footer class="mt-8 sm:mt-12 text-center text-slate-400 text-[10px] sm:text-xs space-y-2">
            <p>‚ÄúAnd We have certainly made the Quran easy for remembrance...‚Äù (54:17)</p>
            <p>¬© Noor Transliterate - Built with Noor AI</p>
        </footer>
    </div>

    <!-- API Key Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl border-t-4 border-emerald-500">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-slate-800 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></svg>
                    Setup AI Features
                </h3>
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-slate-600">‚úï</button>
            </div>
            <p class="text-xs text-slate-500 mb-4 leading-relaxed">
                To enable AI features on the released app, please provide your Gemini API key. It will be saved securely in your browser.
            </p>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-slate-700 mb-1">Gemini API Key</label>
                    <input type="password" id="apiKeyInput" placeholder="AIzaSy..." class="w-full p-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <button onclick="saveApiKey()" class="w-full py-2 bg-emerald-600 text-white rounded-lg font-semibold hover:bg-emerald-700 transition-all shadow-md">
                    Save Key
                </button>
                <div class="text-center">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-[10px] text-blue-500 hover:underline">Get a free key here ‚Üó</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl border-t-4 border-red-500">
            <div class="flex items-center gap-3 mb-4">
                <div class="bg-red-100 p-2 rounded-full text-red-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                </div>
                <h3 class="font-bold text-slate-800">Connection Error</h3>
            </div>
            <p id="errorMessage" class="text-sm text-slate-600 mb-6 leading-relaxed">The AI features require an API key to work on live websites. Please check your configuration.</p>
            <div class="flex gap-2">
                <button onclick="document.getElementById('errorModal').classList.add('hidden')" class="flex-1 py-2 bg-slate-200 text-slate-700 rounded-xl font-semibold hover:bg-slate-300 transition-all">Close</button>
                <button onclick="document.getElementById('errorModal').classList.add('hidden'); toggleSettings();" class="flex-1 py-2 bg-emerald-600 text-white rounded-xl font-semibold hover:bg-emerald-700 transition-all">Settings</button>
            </div>
        </div>
    </div>

    <script>
        const environmentApiKey = ""; // Leave empty for preview default
        let currentMode = 'standard';
        let wordSuggestions = []; 
        
        const mainInput = document.getElementById('mainInput');
        const output1 = document.getElementById('output1');
        const output2 = document.getElementById('output2');
        const output2Container = document.getElementById('output2Container');
        const inputLabel = document.getElementById('inputLabel');
        const keyboardSection = document.getElementById('keyboardSection');
        const suggestionMenu = document.getElementById('suggestionMenu');
        const suggestionList = document.getElementById('suggestionList');
        const aiLoading = document.getElementById('aiLoading');
        const aiInsightsContainer = document.getElementById('aiInsightsContainer');
        const aiInsightsContent = document.getElementById('aiInsightsContent');
        const errorModal = document.getElementById('errorModal');
        const errorMessage = document.getElementById('errorMessage');
        const settingsModal = document.getElementById('settingsModal');
        const apiKeyInput = document.getElementById('apiKeyInput');

        // Load saved API key if exists
        window.addEventListener('load', () => {
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) apiKeyInput.value = savedKey;
            initKeyboard();
            setMode('standard');
        });

        function toggleSettings() {
            settingsModal.classList.toggle('hidden');
        }

        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                toggleSettings();
                alert("API Key saved successfully! AI features are now ready.");
            } else {
                localStorage.removeItem('gemini_api_key');
                alert("API Key removed.");
            }
        }

        const arToEn = {
            'ÿß': 'a', 'ÿ£': 'a', 'ÿ•': 'i', 'ÿ¢': 'aa', 'ÿ®': 'b', 'ÿ™': 't', 'ÿ´': 'th',
            'ÿ¨': 'j', 'ÿ≠': 'h', 'ÿÆ': 'kh', 'ÿØ': 'd', 'ÿ∞': 'dh', 'ÿ±': 'r', 'ÿ≤': 'z',
            'ÿ≥': 's', 'ÿ¥': 'sh', 'ÿµ': '·π£', 'ÿ∂': '·∏ç', 'ÿ∑': '·π≠', 'ÿ∏': '·∫ì', 'ÿπ': '‚Äò',
            'ÿ∫': 'gh', 'ŸÅ': 'f', 'ŸÇ': 'q', 'ŸÉ': 'k', 'ŸÑ': 'l', 'ŸÖ': 'm', 'ŸÜ': 'n',
            'Ÿá': 'h', 'Ÿà': 'w', 'Ÿä': 'y', 'ÿ©': 'h', 'Ÿâ': 'a', 'ÿ°': "'", 'ÿ¶': "'", 'ÿ§': "'",
            '\u064E': 'a', '\u064F': 'u', '\u0650': 'i', '\u0651': '', '\u0652': ''
        };

        const chatToAr = {
            "3'": "ÿ∫", "3*": "ÿ∫", "gh": "ÿ∫",
            "6'": "ÿ∏", "6*": "ÿ∏", "zh": "ÿ∏",
            "9'": "ÿ∂", "9*": "ÿ∂", "dh": "ÿ∂",
            "7'": "ÿÆ", "7*": "ÿÆ", "kh": "ÿÆ", "5": "ÿÆ",
            "sh": "ÿ¥", "ch": "ÿ¥", "4": "ÿ¥",
            "th": "ÿ´", "ee": "Ÿä", "oo": "Ÿà", "ou": "Ÿà", "uu": "Ÿà", "aa": "ÿß",
            "2": "ÿ£", "3": "ÿπ", "6": "ÿ∑", "7": "ÿ≠", "8": "ŸÇ", "9": "ÿµ",
            "a": "ÿß", "b": "ÿ®", "t": "ÿ™", "j": "ÿ¨", "d": "ÿØ", "r": "ÿ±", "z": "ÿ≤",
            "s": "ÿ≥", "f": "f", "k": "ŸÉ", "l": "ŸÑ", "m": "ŸÖ", "n": "ŸÜ", "h": "Ÿá", 
            "w": "Ÿà", "y": "Ÿä", "i": "Ÿä", "u": "Ÿà", "e": "ÿß", "o": "Ÿà"
        };

        const commonPhrases = {
            "inshallah": "ÿ•ŸÜ ÿ¥ÿßÿ° ÿßŸÑŸÑŸá",
            "mashaallah": "ŸÖÿß ÿ¥ÿßÿ° ÿßŸÑŸÑŸá",
            "hamdullah": "ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá",
            "alhamdulillah": "ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá",
            "bismillah": "ÿ®ÿ≥ŸÖ ÿßŸÑŸÑŸá",
            "subhanallah": "ÿ≥ÿ®ÿ≠ÿßŸÜ ÿßŸÑŸÑŸá",
            "astaghfirullah": "ÿ£ÿ≥ÿ™ÿ∫ŸÅÿ± ÿßŸÑŸÑŸá",
            "allah": "ÿßŸÑŸÑŸá",
            "muhammad": "ŸÖÿ≠ŸÖÿØ"
        };

        const smartGroups = {
            'ÿ≥': ['ÿµ', 'ÿ≤', 'ÿ´', 'ÿ∏'], 'ÿµ': ['ÿ≥', 'ÿ∂', 'ÿ≤'],
            'ÿ™': ['ÿ∑', 'ÿØ', 'ÿ´'], 'ÿ∑': ['ÿ™', 'ÿ∏', 'ÿ∂'],
            'ÿØ': ['ÿ∂', 'ÿØ', 'ÿ∞'], 'ÿ∂': ['ÿØ', 'ÿ∏', 'ÿµ'],
            'Ÿá': ['ÿ≠', 'ÿ©', 'ÿß'], 'ÿ≠': ['ÿÆ', 'Ÿá', 'ÿπ'],
            'ŸÉ': ['ŸÇ', 'ŸÉ'], 'ŸÇ': ['ŸÉ', 'ŸÇ'],
            'ÿ≤': ['ÿ∞', 'ÿ∏', 'ÿ≥'], 'ÿ∞': ['ÿ≤', 'ÿ∏', 'ÿØ'], 'ÿ∏': ['ÿ∞', 'ÿ≤', 'ÿ∂', 'ÿ∑'],
            'ÿπ': ['ÿß', 'ÿ≠', 'ÿ°'], 'ÿß': ['ÿπ', 'Ÿá', 'ÿ£', 'ÿ•', 'Ÿâ']
        };

        const sortedArabiziKeys = Object.keys(chatToAr).sort((a, b) => b.length - a.length);

        const keys = [
            'ÿ∂', 'ÿµ', 'ÿ´', 'ŸÇ', 'ŸÅ', 'ÿ∫', 'ÿπ', 'Ÿá', 'ÿÆ', 'ÿ≠',
            'ÿ¥', 'ÿ≥', 'Ÿä', 'ÿ®', 'ŸÑ', 'ÿß', 'ÿ™', 'ŸÜ', 'ŸÖ', 'ŸÉ',
            'ÿ∏', 'ÿ∑', 'ÿ∞', 'ÿØ', 'ÿ≤', 'ÿ±', 'Ÿà', 'ÿ©', 'Ÿâ', 'ÿ°',
            '\u064E', '\u064F', '\u0650', '\u0651', '\u0652', 'ÿ¢', 'ÿ£', 'ÿ•', 'Bksp', 'Space'
        ];

        // --- GEMINI API INTEGRATION ---

        async function callGemini(payload, model = 'gemini-2.5-flash-preview-09-2025', isTts = false) {
            // Priority: User Saved Key -> Environment Key
            const savedKey = localStorage.getItem('gemini_api_key');
            const keyToUse = savedKey || environmentApiKey;

            if (!keyToUse) {
                toggleSettings(); // Open settings for user to paste key
                throw new Error("API Key Missing. Please paste your key in Settings.");
            }

            const baseUrl = "https://generativelanguage.googleapis.com/v1beta/models/";
            const endpoint = isTts ? "gemini-2.5-flash-preview-tts" : model;
            const url = `${baseUrl}${endpoint}:generateContent?key=${keyToUse}`;

            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error?.message || 'API Error');
                    }
                    
                    return await response.json();
                } catch (e) {
                    if (i === 4) throw e;
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
            }
        }

        function extractJson(text) {
            // Safe JSON extraction finding first { and last }
            const start = text.indexOf('{');
            const end = text.lastIndexOf('}');
            if (start !== -1 && end !== -1) {
                try {
                    return JSON.parse(text.substring(start, end + 1));
                } catch (e) {
                    console.error("Manual JSON Parse Failed", e);
                }
            }
            throw new Error("AI returned invalid format");
        }

        function showError(msg) {
            errorMessage.innerText = msg;
            errorModal.classList.remove('hidden');
        }

        async function aiRefineText() {
            const input = mainInput.value.trim();
            if (!input) return;

            aiLoading.classList.remove('hidden');
            document.getElementById('aiLoadingText').innerText = "AI Refinement in progress...";

            const prompt = `Convert the following Arabizi (Arabic chat language) text into perfect, formal Arabic script and provide a precise transliteration: "${input}". 
            Output ONLY strict JSON format with keys "arabic" and "transliteration". Use standard formal transliteration symbols (like ·π£ for Sad, etc).`;

            try {
                const result = await callGemini({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType: "application/json" }
                });

                const data = extractJson(result.candidates[0].content.parts[0].text);
                
                // Update local word state
                const words = data.arabic.split(/\s+/);
                output2.innerHTML = "";
                wordSuggestions = words.map(w => ({
                    current: w,
                    alternatives: generateAlternatives(w)
                }));

                words.forEach((w, idx) => {
                    let span = document.createElement('span');
                    span.className = "selectable-word";
                    span.innerText = w;
                    span.onclick = (e) => showSuggestions(e, idx);
                    output2.appendChild(span);
                    output2.appendChild(document.createTextNode(" "));
                });

                output1.innerText = data.transliteration;
                if (currentMode === 'arabizi') output2Container.classList.remove('hidden');

            } catch (error) {
                showError(error.message);
            } finally {
                aiLoading.classList.add('hidden');
            }
        }

        async function aiReflectText() {
            const input = (currentMode === 'arabizi') 
                ? wordSuggestions.map(s => s.current).join(" ") 
                : mainInput.value.trim();

            if (!input || input === "Waiting..." || input === "-") return;

            aiLoading.classList.remove('hidden');
            document.getElementById('aiLoadingText').innerText = "AI Reflection in progress...";

            const prompt = `Provide a deep linguistic and spiritual reflection on the following Arabic phrase: "${input}". 
            Explain the root meanings, translation, and significance in an Islamic or Arabic cultural context. Keep it concise but profound.`;

            try {
                const result = await callGemini({
                    contents: [{ parts: [{ text: prompt }] }]
                });

                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                aiInsightsContent.innerText = text;
                aiInsightsContainer.classList.remove('hidden');

            } catch (error) {
                showError(error.message);
            } finally {
                aiLoading.classList.add('hidden');
            }
        }

        async function aiSpeakText() {
            const input = (currentMode === 'arabizi') 
                ? wordSuggestions.map(s => s.current).join(" ") 
                : mainInput.value.trim();

            if (!input || input === "Waiting..." || input === "-") return;

            aiLoading.classList.remove('hidden');
            document.getElementById('aiLoadingText').innerText = "AI Voice generation...";

            try {
                const result = await callGemini({
                    contents: [{ parts: [{ text: `Say clearly in a serene tone: ${input}` }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Kore" }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                }, 'gemini-2.5-flash-preview-tts', true);

                const inlineData = result.candidates[0].content.parts[0].inlineData;
                const pcmBase64 = inlineData.data;
                const mimeType = inlineData.mimeType;
                
                // Extract sample rate from mimeType if possible, else default to 24000
                const rateMatch = mimeType.match(/rate=(\d+)/);
                const sampleRate = rateMatch ? parseInt(rateMatch[1]) : 24000;
                
                // Convert PCM to WAV
                const binaryString = atob(pcmBase64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
                
                const wavHeader = createWavHeader(len, sampleRate);
                const blob = new Blob([wavHeader, bytes], { type: 'audio/wav' });
                const url = URL.createObjectURL(blob);
                const audio = new Audio(url);
                audio.play();

            } catch (error) {
                showError(error.message);
            } finally {
                aiLoading.classList.add('hidden');
            }
        }

        function createWavHeader(dataLength, sampleRate) {
            const buffer = new ArrayBuffer(44);
            const view = new DataView(buffer);
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
            };
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true); // Mono
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, dataLength, true);
            return buffer;
        }

        // --- END GEMINI API ---

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('modeStandard').classList.toggle('active-tab', mode === 'standard');
            document.getElementById('modeArabizi').classList.toggle('active-tab', mode === 'arabizi');
            aiInsightsContainer.classList.add('hidden');
            
            if (mode === 'standard') {
                inputLabel.innerText = "Arabic Script (ÿπ)";
                mainInput.classList.add('arabic-text');
                mainInput.style.textAlign = 'right';
                output2Container.classList.add('hidden');
                keyboardSection.classList.remove('hidden');
            } else {
                inputLabel.innerText = "Arabizi Text (3rb)";
                mainInput.classList.remove('arabic-text');
                mainInput.style.textAlign = 'left';
                output2Container.classList.remove('hidden');
                keyboardSection.classList.add('hidden');
            }
            clearText();
        }

        function initKeyboard() {
            const grid = document.getElementById('keyboardGrid');
            keys.forEach(key => {
                const btn = document.createElement('button');
                let display = key;
                if(key === '\u064E') display = '‚óåŸé';
                if(key === '\u064F') display = '‚óåŸè';
                if(key === '\u0650') display = '‚óåŸê';
                if(key === '\u0651') display = '‚óåŸë';
                if(key === '\u0652') display = '‚óåŸí';

                btn.className = `keyboard-key p-2 sm:p-3 bg-white border-b-2 border-slate-200 rounded-lg shadow-sm font-bold text-sm sm:text-base md:text-lg hover:bg-emerald-50 hover:border-emerald-400 text-slate-700 ${key === 'Bksp' || key === 'Space' ? 'bg-slate-100 col-span-1 text-[8px] sm:text-[10px]' : ''}`;
                btn.innerText = display;
                btn.onclick = () => handleKeyPress(key);
                grid.appendChild(btn);
            });
        }

        function handleKeyPress(key) {
            const start = mainInput.selectionStart;
            const end = mainInput.selectionEnd;
            if (key === 'Bksp') {
                mainInput.value = mainInput.value.substring(0, start - 1) + mainInput.value.substring(end);
                mainInput.selectionStart = mainInput.selectionEnd = start - 1;
            } else if (key === 'Space') {
                mainInput.value = mainInput.value.substring(0, start) + ' ' + mainInput.value.substring(end);
                mainInput.selectionStart = mainInput.selectionEnd = start + 1;
            } else {
                mainInput.value = mainInput.value.substring(0, start) + key + mainInput.value.substring(end);
                mainInput.selectionStart = mainInput.selectionEnd = start + 1;
            }
            mainInput.focus();
            process();
        }

        function convertWordToArabic(word) {
            if (commonPhrases[word]) return commonPhrases[word];
            let w = "";
            let j = 0;
            if (word.startsWith('al-') || word.startsWith('el-')) { w += "ÿßŸÑ"; j = 3; }
            else if (word.startsWith('al') || word.startsWith('el')) { w += "ÿßŸÑ"; j = 2; }
            while(j < word.length) {
                if (word[j] === word[j+1] && chatToAr[word[j]] && !'aoe'.includes(word[j])) {
                    w += chatToAr[word[j]] + "\u0651";
                    j += 2;
                    continue;
                }
                let matched = false;
                for (const key of sortedArabiziKeys) {
                    if (word.substr(j, key.length) === key) {
                        w += chatToAr[key];
                        j += key.length;
                        matched = true;
                        break;
                    }
                }
                if (!matched) { w += word[j]; j++; }
            }
            return w;
        }

        function generateAlternatives(arWord) {
            let alts = new Set();
            for (let i = 0; i < arWord.length; i++) {
                let char = arWord[i];
                if (smartGroups[char]) {
                    smartGroups[char].forEach(replacement => {
                        let alt = arWord.substring(0, i) + replacement + arWord.substring(i + 1);
                        alts.add(alt);
                    });
                }
            }
            return Array.from(alts);
        }

        function process() {
            const text = mainInput.value;
            if (!text.trim()) {
                output1.innerText = "Waiting...";
                output2.innerHTML = "-";
                wordSuggestions = [];
                return;
            }

            if (currentMode === 'standard') {
                let res = "";
                for (let i = 0; i < text.length; i++) {
                    let char = text[i];
                    if (text[i+1] === '\u0651') { 
                        let b = arToEn[char] || "";
                        res += b + b; i++; continue;
                    }
                    if (char === 'ÿß' && text[i+1] === 'ŸÑ' && (i === 0 || text[i-1] === ' ')) {
                        res += "Al-"; i++; continue;
                    }
                    res += arToEn[char] || char;
                }
                output1.innerText = res.charAt(0).toUpperCase() + res.slice(1);
            } else {
                let words = text.split(/\s+/);
                output2.innerHTML = "";
                wordSuggestions = [];
                words.forEach((word, idx) => {
                    if (!word) return;
                    let primaryAr = convertWordToArabic(word.toLowerCase());
                    let alts = generateAlternatives(primaryAr);
                    wordSuggestions.push({ current: primaryAr, alternatives: alts });
                    let span = document.createElement('span');
                    span.className = "selectable-word";
                    span.innerText = primaryAr;
                    span.onclick = (e) => showSuggestions(e, idx);
                    output2.appendChild(span);
                    output2.appendChild(document.createTextNode(" "));
                });
                syncFinalTransliteration();
            }
        }

        function showSuggestions(event, wordIdx) {
            const data = wordSuggestions[wordIdx];
            suggestionList.innerHTML = "";
            const currentItem = document.createElement('div');
            currentItem.className = "px-4 py-2 bg-emerald-50 text-emerald-700 font-bold arabic-text border-b cursor-default";
            currentItem.innerText = data.current + " (Active)";
            suggestionList.appendChild(currentItem);
            if (data.alternatives.length > 0) {
                data.alternatives.forEach(alt => {
                    const btn = document.createElement('button');
                    btn.className = "px-4 py-2 text-left hover:bg-slate-100 arabic-text transition-colors border-b last:border-0";
                    btn.innerText = alt;
                    btn.onclick = () => {
                        selectAlternative(wordIdx, alt);
                        suggestionMenu.style.display = 'none';
                    };
                    suggestionList.appendChild(btn);
                });
            }
            const rect = event.target.getBoundingClientRect();
            suggestionMenu.style.left = (rect.left) + "px";
            suggestionMenu.style.top = (window.scrollY + rect.bottom + 5) + "px";
            suggestionMenu.style.display = 'block';
            const closeMenu = (e) => {
                if (!suggestionMenu.contains(e.target) && e.target !== event.target) {
                    suggestionMenu.style.display = 'none';
                    document.removeEventListener('click', closeMenu);
                }
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 10);
        }

        function selectAlternative(idx, newWord) {
            wordSuggestions[idx].current = newWord;
            const spans = output2.querySelectorAll('.selectable-word');
            if (spans[idx]) spans[idx].innerText = newWord;
            syncFinalTransliteration();
        }

        function syncFinalTransliteration() {
            let finalAr = wordSuggestions.map(s => s.current).join(" ");
            let res = "";
            for (let i = 0; i < finalAr.length; i++) {
                let char = finalAr[i];
                if (char === 'ÿß' && finalAr[i+1] === 'ŸÑ' && (i === 0 || finalAr[i-1] === ' ')) {
                    res += "Al-"; i++; continue;
                }
                if (finalAr[i+1] === '\u0651') {
                    let letter = arToEn[char] || char;
                    res += letter + letter; i++; continue;
                }
                res += arToEn[char] || char;
            }
            output1.innerText = res.charAt(0).toUpperCase() + res.slice(1);
        }

        function clearText() {
            mainInput.value = "";
            process();
            aiInsightsContainer.classList.add('hidden');
            mainInput.focus();
        }

        function copyText(id) {
            const txt = (id === 'output2') ? wordSuggestions.map(s => s.current).join(" ") : document.getElementById(id).innerText;
            if (txt === "Waiting..." || !txt) return;
            navigator.clipboard.writeText(txt).then(() => {
                const b = document.getElementById('copyBadge');
                b.classList.remove('hidden');
                setTimeout(() => b.classList.add('hidden'), 2000);
            });
        }

        mainInput.addEventListener('input', process);
    </script>
</body>
</html>
